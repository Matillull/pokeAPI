{% extends 'pokedex/base.html' %}

{% block title %}Comparar Pokémon{% endblock %}

{% block content %}
<div class="container">
    <h2 class="text-center my-4">Comparar Pokémon</h2>
    
    <!-- Formulario con inputs y autocompletado filtrado -->
    <form method="post" class="mb-5" id="compare-form">
        {% csrf_token %}
        <div class="row g-3">
            <div class="col-md-6 position-relative">
                <input type="text" name="pokemon1" id="pokemon1" 
                       class="form-control" 
                       placeholder="Primer Pokémon"
                       autocomplete="off"
                       required>
                <div class="autocomplete-list"></div>
            </div>
            <div class="col-md-6 position-relative">
                <input type="text" name="pokemon2" id="pokemon2" 
                       class="form-control" 
                       placeholder="Segundo Pokémon"
                       autocomplete="off"
                       required>
                <div class="autocomplete-list"></div>
            </div>
        </div>
        <div class="text-center mt-3">
            <button type="submit" class="btn btn-primary btn-lg">
                <span id="compare-spinner" class="spinner-border spinner-border-sm d-none" role="status"></span>
                Comparar
            </button>
        </div>
    </form>

    <!-- Resultados de comparación -->
    <div id="comparison-results">
        {% if comparacion %}
        <div class="row justify-content-center g-4">
            {% for poke in comparacion %}
            <div class="col-lg-5 col-md-6">
                <div class="pokemon-card rounded-4 p-4 shadow-lg" 
                     style="background-color: {{ poke.bg_color|default:'#f8d030' }};">
                    <!-- Encabezado -->
                    <div class="text-center">
                        <h2 class="fw-bold text-black mb-3">{{ poke.name|capfirst }}</h2>
                        <img src="{{ poke.sprites.front_default }}" 
                             class="img-fluid pokemon-sprite mb-3" 
                             alt="{{ poke.name }}"
                             loading="lazy">
                    </div>

                    <!-- Detalles -->
                    <div class="pokemon-details">
                        <table class="table table-borderless">
                            <tbody>
                                <tr>
                                    <th class="w-25">Tipos:</th>
                                    <td>
                                        {% for type in poke.types %}
                                        <span class="badge bg-dark me-1">{{ type }}</span>
                                        {% endfor %}
                                    </td>
                                </tr>
                                <tr>
                                    <th>Habilidades:</th>
                                    <td>
                                        {% for ability in poke.abilities %}
                                        <span class="d-inline-block me-2">{{ ability.ability.name }}</span>
                                        {% endfor %}
                                    </td>
                                </tr>
                                <tr>
                                    <th>Debilidades:</th>
                                    <td>
                                        {% for weakness in poke.weaknesses %}
                                        <span class="badge bg-danger me-1">{{ weakness }}</span>
                                        {% endfor %}
                                    </td>
                                </tr>
                            </tbody>
                        </table>

                        <!-- Estadísticas con gráficos -->
                        <h5 class="mb-3 text-center"><strong>Estadísticas Base</strong></h5>
                        <div class="pokemon-stats">
                            {% for stat in poke.stats %}
                            <div class="stat-row mb-3">
                                <div class="d-flex justify-content-between mb-1">
                                    <span class="text-capitalize fw-bold">{{ stat.stat.name }}</span>
                                    <span class="stat-value">{{ stat.base_stat }}</span>
                                </div>
                                <div class="progress" style="height: 20px;">
                                    <div class="progress-bar {% cycle 'bg-warning' 'bg-info' %}" 
                                         role="progressbar" 
                                         style="width: calc({{ stat.base_stat }} * 100 / 150)%"
                                         aria-valuenow="{{ stat.base_stat }}"
                                         aria-valuemin="0"
                                         aria-valuemax="150">
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>

    <div class="text-center mt-4">
        <a href="/" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Volver al inicio
        </a>
    </div>
</div>

<!-- Script para autocompletado filtrado y envío asíncrono -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const inputs = [document.getElementById('pokemon1'), document.getElementById('pokemon2')];
    const spinner = document.getElementById('compare-spinner');
    let pokemonList = [];

    // Cargar lista completa una vez
    fetch('/api/pokemon-list/')
      .then(res => {
          if (!res.ok) throw new Error('Error al cargar la lista');
          return res.json();
      })
      .then(data => {
          pokemonList = data;
      })
      .catch(err => console.error(err));

    // Mostrar lista de autocompletado filtrada
    function showAutocompleteList(input) {
        const listContainer = input.nextElementSibling;
        const val = input.value.toLowerCase();
        listContainer.innerHTML = '';
        if (!val) return;

        const filtered = pokemonList.filter(name => name.startsWith(val)).slice(0, 10);

        filtered.forEach(name => {
            const item = document.createElement('div');
            item.textContent = name;
            item.classList.add('autocomplete-item', 'p-2', 'border', 'border-bottom-0', 'bg-white');
            item.style.cursor = 'pointer';
            item.addEventListener('click', () => {
                input.value = name;
                listContainer.innerHTML = '';
            });
            listContainer.appendChild(item);
        });
    }

    inputs.forEach(input => {
        input.addEventListener('input', () => showAutocompleteList(input));
        // Cerrar lista si se hace click fuera del input
        document.addEventListener('click', (e) => {
            if (e.target !== input) {
                input.nextElementSibling.innerHTML = '';
            }
        });
    });

    // Envío asíncrono del formulario
    const form = document.getElementById('compare-form');
    if (form && spinner) {
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            spinner.classList.remove('d-none');

            try {
                const formData = new FormData(form);
                const response = await fetch('/compare/', {
                    method: 'POST',
                    body: formData,
                    headers: {'X-Requested-With': 'XMLHttpRequest'}
                });

                if (response.ok) {
                    const html = await response.text();
                    const resultsContainer = document.getElementById('comparison-results');
                    const doc = new DOMParser().parseFromString(html, 'text/html');
                    const newResults = doc.getElementById('comparison-results');
                    if (resultsContainer && newResults) {
                        resultsContainer.innerHTML = newResults.innerHTML;
                    }
                } else {
                    alert('Error al obtener los resultados');
                }
            } catch (error) {
                console.error(error);
                alert('Ocurrió un error al comparar los Pokémon');
            } finally {
                spinner.classList.add('d-none');
            }
        });
    }
});
</script>

<style>
    .pokemon-card {
        transition: transform 0.3s ease;
        margin-bottom: 1.5rem;
    }
    .pokemon-card:hover {
        transform: translateY(-5px);
    }
    .pokemon-sprite {
        transition: transform 0.3s ease;
        max-width: 150px;
        height: auto;
    }
    .pokemon-sprite:hover {
        transform: scale(1.1);
    }
    .stat-row {
        max-width: 300px;
        margin: 0 auto;
    }
    .progress {
        background-color: #e9ecef;
        border-radius: 0.25rem;
        overflow: hidden;
    }
    .progress-bar {
        transition: width 0.6s ease;
    }
    .bg-warning {
        background-color: #ffc107 !important;
    }
    .bg-info {
        background-color: #0dcaf0 !important;
    }

    /* Estilos para lista de autocompletado */
    .autocomplete-list {
        position: absolute;
        z-index: 1000;
        width: 100%;
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid #ced4da;
        border-top: none;
        background: white;
        border-radius: 0 0 .25rem .25rem;
        box-shadow: 0 4px 6px rgb(0 0 0 / 0.1);
    }
    .autocomplete-item:hover {
        background-color: #e9ecef;
    }
</style>

{% endblock %}
